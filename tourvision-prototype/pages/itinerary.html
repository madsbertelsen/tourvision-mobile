<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Itinerary Builder - TourVision</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style type="text/tailwindcss">
        @layer components {
            .btn-primary {
                @apply px-4 py-2 bg-black text-white rounded-full hover:bg-gray-800 transition text-sm font-medium;
            }
            .btn-primary-lg {
                @apply w-14 h-14 bg-black text-white rounded-full shadow-lg hover:shadow-xl hover:bg-gray-800 transition flex items-center justify-center;
            }
            .btn-icon {
                @apply w-10 h-10 rounded-full hover:bg-gray-100 transition-colors flex items-center justify-center;
            }
            .btn-icon-sm {
                @apply w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center;
            }
            .btn-icon-black {
                @apply w-10 h-10 bg-black text-white rounded-full hover:bg-gray-800 transition-colors flex items-center justify-center;
            }
            .toggle-pill {
                @apply px-3 py-1.5 rounded-full text-sm font-medium transition-all;
            }
            .toggle-pill-active {
                @apply bg-black text-white;
            }
            .toggle-pill-inactive {
                @apply text-gray-700 hover:bg-gray-100;
            }
            .header-main {
                @apply bg-white border-b border-gray-200 sticky top-0 z-40 shadow-sm;
            }
            .dropdown-menu {
                @apply absolute bg-white rounded-xl shadow-xl border border-gray-100 z-50;
            }
            .dropdown-item {
                @apply w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg flex items-center space-x-3;
            }
            .icon-container {
                @apply w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center;
            }
            .card {
                @apply bg-white rounded-2xl shadow-lg border border-gray-100 p-4;
            }
            .card-sm {
                @apply bg-white rounded-xl shadow-sm border border-gray-100 p-3;
            }
            .badge-green {
                @apply px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full font-medium;
            }
            .trip-card {
                @apply bg-white rounded-2xl shadow-lg border border-gray-100 p-4 flex-shrink-0 w-64;
            }
            .trip-card-header {
                @apply flex items-center justify-between mb-2;
            }
            .trip-card-title {
                @apply font-semibold text-gray-900 mb-1;
            }
            .trip-card-subtitle {
                @apply text-sm text-gray-600;
            }
            .trip-card-footer {
                @apply mt-3 flex items-center text-xs text-gray-500;
            }
            .map-marker {
                @apply w-10 h-10 rounded-full flex items-center justify-center text-white font-bold shadow-lg cursor-pointer transform hover:scale-110 transition;
            }
            .pro-tip {
                @apply bg-green-50 border border-green-200 rounded-xl p-4 my-4;
            }
            .pro-tip-title {
                @apply font-semibold;
            }
            .heading-xl {
                @apply text-xl font-semibold text-gray-900;
            }
            .select-dropdown {
                @apply px-3 py-2 bg-transparent text-gray-900 focus:outline-none;
            }
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .drag-over {
            background-color: rgba(59, 130, 246, 0.1);
            border-color: rgb(59, 130, 246);
        }
    </style>
</head>
<body class="h-full bg-gray-50" x-data="{...collaborationFeatures(), ...itineraryBuilder()}" x-init="init()">
    <!-- 
    ==========================================
    TIPTAP DOCUMENT SCHEMA SPECIFICATION
    ==========================================
    
    This itinerary page represents a TipTap document with the following structure:
    
    DOCUMENT ROOT:
    {
      type: 'doc',
      attrs: {
        // Document Metadata
        tripId: 'paris-2024-09',
        tripTitle: 'Paris Adventure - 5 Days',
        dateRange: {
          start: '2024-09-15',
          end: '2024-09-19'
        },
        visibility: 'shared', // 'private' | 'shared' | 'public'
        owner: 'user-123',
        collaborators: [
          { userId: 'sarah-chen', name: 'Sarah Chen', role: 'editor', avatar: 'SC', color: '#8B5CF6' },
          { userId: 'mike-johnson', name: 'Mike Johnson', role: 'viewer', avatar: 'MJ', color: '#3B82F6' },
          { userId: 'emma-park', name: 'Emma Park', role: 'editor', avatar: 'EP', color: '#10B981' }
        ],
        
        // View State (persisted with document)
        viewPreferences: {
          mode: 'split', // 'text' | 'map' | 'split'
          selectedDay: 'all',
          mapBounds: null,
          commentsEnabled: false,
          editingEnabled: false
        },
        
        // Sync Metadata
        version: 42,
        lastModified: '2024-09-13T10:30:00Z',
        lastModifiedBy: 'sarah-chen',
        lastSyncedAt: '2024-09-13T10:30:00Z'
      },
      content: [...] // Day nodes, destination nodes, etc.
    }
    -->
    
    <!-- Header -->
    <!-- 
    SCHEMA: Header maps to document.attrs metadata
    - Trip title is editable and syncs to doc.attrs.tripTitle
    - View mode buttons update doc.attrs.viewPreferences.mode
    - Collaboration dropdown state stored in doc.attrs.viewPreferences
    -->
    <header class="header-main">
        <div class="px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <a href="../index.html" class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-lg">T</span>
                        </div>
                        <span class="font-bold text-xl text-gray-900">TourVision</span>
                    </a>
                    <span class="text-gray-400">/</span>
                    <h1 class="heading-xl">Paris Adventure - 5 Days</h1>
                </div>
                <div class="flex items-center space-x-3">
                    <!-- View Toggle -->
                    <div class="flex items-center space-x-1">
                        <button @click="viewMode = 'split'" :class="viewMode === 'split' ? 'toggle-pill-active' : 'toggle-pill-inactive'" class="toggle-pill">
                            Split
                        </button>
                        <button @click="viewMode = 'text'" :class="viewMode === 'text' ? 'toggle-pill-active' : 'toggle-pill-inactive'" class="toggle-pill">
                            Text
                        </button>
                        <button @click="viewMode = 'map'" :class="viewMode === 'map' ? 'toggle-pill-active' : 'toggle-pill-inactive'" class="toggle-pill">
                            Map
                        </button>
                    </div>
                    
                    <div class="relative" x-data="{ showCollabMenu: false }">
                        <button @click="showCollabMenu = !showCollabMenu" class="btn-icon-black">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m9.032 4.026a9.001 9.001 0 01-7.432 0"></path>
                            </svg>
                        </button>
                        <div x-show="showCollabMenu" @click.outside="showCollabMenu = false" x-transition class="absolute right-0 mt-2 w-64 bg-white rounded-xl shadow-xl border border-gray-100 z-50">
                            <div class="p-4">
                                <h4 class="font-semibold text-gray-900 mb-3">Share & Collaborate</h4>
                                <div class="space-y-2">
                                    <button @click="shareWithLink()" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg flex items-center space-x-3">
                                        <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                                            </svg>
                                        </div>
                                        <span class="text-sm font-medium text-gray-900">Copy link</span>
                                    </button>
                                    <button @click="inviteCollaborator()" class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg flex items-center space-x-3">
                                        <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                            </svg>
                                        </div>
                                        <span class="text-sm font-medium text-gray-900">Invite</span>
                                    </button>
                                    <div class="border-t border-gray-100 pt-2 mt-2">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-xs text-gray-500">Enable comments</span>
                                            <label class="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" @change="toggleComments()" x-model="commentsEnabled" class="sr-only peer">
                                                <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-500"></div>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-500">Allow edits</span>
                                            <label class="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" @change="toggleEditing()" x-model="editingEnabled" class="sr-only peer">
                                                <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-500"></div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="btn-primary">
                        Save
                    </button>
                    <button class="btn-icon">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="flex h-[calc(100vh-73px)]">
        <!-- Left Panel - Text Editor -->
        <div :class="viewMode === 'map' ? 'hidden' : (viewMode === 'split' ? 'w-1/2' : 'w-full')" class="flex flex-col bg-white relative">
            <!-- Editor Toolbar -->
            <div class="px-6 py-3 border-b border-gray-100 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <button class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h8m-8 6h16"></path>
                        </svg>
                    </button>
                    <button class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded font-bold">B</button>
                    <button class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded italic">I</button>
                    <button class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                        </svg>
                    </button>
                </div>
                <div class="flex items-center space-x-2 text-sm text-gray-500 dark:text-gray-400">
                    <span>Auto-saved</span>
                    <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                </div>
            </div>
            
            <!-- Text Editor Content -->
            <!-- 
            SCHEMA: Text Editor View
            This contenteditable div represents the rendered TipTap document.
            The content here is the visual representation of the document's node tree.
            -->
            <div class="flex-1 overflow-y-auto relative">
                <!-- Comment Indicators (Illustration) -->
                <!-- 
                SCHEMA: Comment System
                Comments are stored as marks on specific text ranges or as attributes on nodes.
                
                CommentMark schema:
                {
                  type: 'comment',
                  attrs: {
                    commentId: 'comment-1',
                    author: 'sarah-chen',
                    authorName: 'Sarah Chen',
                    text: 'Should we book the Eiffel Tower tickets now?',
                    timestamp: '2024-09-13T10:20:00Z',
                    resolved: false,
                    replies: [],
                    position: { line: 180, node: 'destination-1' }
                  }
                }
                
                Suggestion schema (special type of comment):
                {
                  type: 'suggestion',
                  attrs: {
                    suggestionId: 'suggestion-1',
                    author: 'mike-johnson',
                    originalText: '3-4 hours',
                    suggestedText: '4-5 hours',
                    reason: 'More time needed for highlights',
                    status: 'pending', // 'pending' | 'accepted' | 'rejected'
                    targetNode: 'destination-2'
                  }
                }
                -->
                <div x-show="commentsEnabled" class="absolute left-4 top-0 h-full w-12">
                    <!-- Comment Indicator 1 -->
                    <div class="absolute" style="top: 180px;">
                        <div class="w-8 h-8 bg-yellow-100 dark:bg-yellow-900/30 border-2 border-yellow-400 rounded-full flex items-center justify-center cursor-pointer hover:scale-110 transition group">
                            <span class="text-xs font-bold text-yellow-600 dark:text-yellow-400">1</span>
                            <!-- Comment Preview on Hover -->
                            <div class="absolute left-10 top-0 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 p-3 opacity-0 group-hover:opacity-100 transition pointer-events-none z-20">
                                <div class="flex items-center gap-2 mb-1">
                                    <div class="w-6 h-6 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white text-[10px] font-semibold">SC</div>
                                    <span class="text-xs font-semibold">Sarah Chen</span>
                                    <span class="text-xs text-gray-500">10 min ago</span>
                                </div>
                                <p class="text-xs text-gray-700 dark:text-gray-300">Should we book the Eiffel Tower tickets now? They might sell out for our dates.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comment Indicator 2 with Suggestion -->
                    <div class="absolute" style="top: 340px;">
                        <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900/30 border-2 border-blue-400 rounded-full flex items-center justify-center cursor-pointer hover:scale-110 transition group">
                            <span class="text-xs font-bold text-blue-600 dark:text-blue-400">2</span>
                            <!-- Comment Preview on Hover -->
                            <div class="absolute left-10 top-0 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 p-3 opacity-0 group-hover:opacity-100 transition pointer-events-none z-20">
                                <div class="flex items-center gap-2 mb-1">
                                    <div class="w-6 h-6 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center text-white text-[10px] font-semibold">MJ</div>
                                    <span class="text-xs font-semibold">Mike Johnson</span>
                                    <span class="text-xs text-gray-500">1 hour ago</span>
                                </div>
                                <p class="text-xs text-gray-700 dark:text-gray-300">I suggest adding more time at the Louvre.</p>
                                <div class="mt-2 p-2 bg-blue-50 dark:bg-blue-900/20 rounded border border-blue-200 dark:border-blue-800">
                                    <p class="text-xs font-semibold text-blue-600 dark:text-blue-400">Suggestion:</p>
                                    <p class="text-xs text-blue-700 dark:text-blue-300">Change to 4-5 hours</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="prose max-w-none p-8" :class="commentsEnabled ? 'ml-12' : ''" contenteditable="true" style="font-family: 'Georgia', serif;">
                    <h1>Paris Adventure Itinerary</h1>
                    <p class="lead">5 days exploring the City of Light - September 15-19, 2024</p>
                    
                    <!-- 
                    SCHEMA: Day Node
                    Each day is a container node:
                    {
                      type: 'day',
                      attrs: {
                        dayNumber: 1,
                        title: 'Iconic Landmarks',
                        date: '2024-09-15',
                        theme: 'Major tourist attractions',
                        estimatedHours: 8,
                        estimatedCost: 113.80,
                        destinations: ['destination-1', 'destination-2', 'destination-3']
                      },
                      content: [...destination and transportation nodes]
                    }
                    -->
                    <h2>Day 1: Iconic Landmarks</h2>
                    <h3>Morning (9:00 AM - 12:00 PM)</h3>
                    <ul>
                        <li class="relative">
                            <!-- 
                            SCHEMA: Destination Node - Eiffel Tower
                            {
                              type: 'destination',
                              attrs: {
                                destinationId: 'destination-1',
                                name: 'Eiffel Tower',
                                coordinates: [48.8584, 2.2945],
                                colorIndex: 0, // Blue marker on map
                                timeSlot: { start: '09:00', end: '12:00' },
                                duration: '2-3 hours',
                                
                                // Participant Assignment (for split groups)
                                participants: [
                                  'sarah-chen',
                                  'mike-johnson',
                                  'emma-park'
                                ], // null means all participants, array means subset
                                splitGroupId: null, // Reference to splitGroup node if part of split
                                
                                // Booking state
                                booking: {
                                  required: true,
                                  status: 'pending', // 'none' | 'pending' | 'booked' | 'confirmed'
                                  suggestedBy: 'sarah-chen',
                                  suggestedAt: '2024-09-13T10:20:00Z',
                                  provider: null, // 'GetYourGuide' | 'Viator' | 'Official' | etc
                                  confirmationNumber: null,
                                  bookedBy: null,
                                  bookedAt: null,
                                  tickets: 2,
                                  price: { amount: 26.80, currency: 'EUR', perPerson: true },
                                  deadline: '2024-09-01', // Book by this date
                                  url: 'https://www.toureiffel.paris/en/rates-opening-times'
                                },
                                
                                // Tips and recommendations
                                tips: [
                                  'Book skip-the-line tickets in advance',
                                  'Best time to avoid crowds',
                                  'Consider stairs to 2nd floor (€10.70) vs elevator (€26.80)'
                                ],
                                
                                // Metadata
                                priority: 'high',
                                category: 'landmark',
                                accessibility: { wheelchairAccessible: true, audioGuide: true },
                                weatherDependent: true
                              }
                            }
                            -->
                            <strong><a href="#" class="text-blue-600 dark:text-blue-400">Eiffel Tower</a></strong> - Start your day at Paris's most famous landmark. Book skip-the-line tickets in advance.
                            <!-- Inline Comment Highlight (when comments enabled) -->
                            <span x-show="commentsEnabled" class="absolute -left-2 top-0 bottom-0 w-1 bg-yellow-400 rounded"></span>
                        </li>
                        <li>Duration: 2-3 hours including elevator ride to summit</li>
                        <li>Cost: €26.80 for summit access</li>
                    </ul>
                    
                    <!-- 
                    SCHEMA: Transportation Node
                    Between destinations, transportation information is stored:
                    {
                      type: 'transportation',
                      attrs: {
                        transportId: 'transport-1',
                        mode: 'metro', // 'walking' | 'metro' | 'bus' | 'taxi' | 'uber' | 'bike'
                        fromDestination: 'destination-1', // Reference to Eiffel Tower
                        toDestination: 'destination-2', // Reference to Louvre
                        duration: '25 minutes',
                        distance: '4.2 km',
                        cost: { amount: 1.90, currency: 'EUR' },
                        route: 'Line 6 to Trocadéro, then Line 9 to Palais-Royal',
                        accessibility: true,
                        alternatives: [
                          { mode: 'taxi', duration: '15 min', cost: 12 },
                          { mode: 'walking', duration: '55 min', cost: 0 }
                        ]
                      }
                    }
                    -->
                    
                    <h3>Afternoon (1:00 PM - 5:00 PM)</h3>
                    <ul>
                        <li class="relative">
                            <strong><a href="#" class="text-purple-600 dark:text-purple-400">Louvre Museum</a></strong> - World's largest art museum
                            <!-- Suggestion Highlight -->
                            <span x-show="commentsEnabled" class="absolute -left-2 top-0 bottom-0 w-1 bg-blue-400 rounded"></span>
                            <span x-show="commentsEnabled" class="ml-2 px-2 py-0.5 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 text-xs rounded">Suggestion</span>
                        </li>
                        <li>Must-see: Mona Lisa, Venus de Milo, Winged Victory</li>
                        <li>Duration: <span x-show="!editingEnabled" class="line-through text-gray-400">3-4 hours</span> <span x-show="editingEnabled" class="text-blue-600 dark:text-blue-400 font-semibold">4-5 hours</span> for highlights</li>
                        <li>Cost: €17 (book online to skip lines)</li>
                    </ul>
                    
                    <h3>Evening (6:00 PM - 9:00 PM)</h3>
                    <ul>
                        <li><strong><a href="#" class="text-green-600 dark:text-green-400">Seine River Cruise</a></strong> - Sunset dinner cruise</li>
                        <li>Departure from Port de la Bourdonnais</li>
                        <li>Duration: 2.5 hours</li>
                        <li>Cost: €70-100 per person</li>
                    </ul>
                    
                    <h2>Day 2: Art & Culture</h2>
                    <h3>Morning (10:00 AM - 1:00 PM)</h3>
                    <ul>
                        <li><strong><a href="#" class="text-orange-600 dark:text-orange-400">Montmartre & Sacré-Cœur</a></strong></li>
                        <li>Explore the artistic neighborhood</li>
                        <li>Visit the basilica for panoramic views</li>
                        <li>Stop at Place du Tertre for street artists</li>
                    </ul>
                    
                    <!-- 
                    SCHEMA: Pro Tip Node
                    Tips and recommendations are special content nodes:
                    {
                      type: 'tip',
                      attrs: {
                        tipId: 'tip-1',
                        icon: '💡',
                        category: 'transportation', // 'booking' | 'timing' | 'budget' | 'local' | 'food'
                        content: 'Take the funicular to reach Sacré-Cœur...',
                        author: 'system', // or userId for user-contributed tips
                        votes: 24, // Community upvotes
                        verified: true, // Verified by locals or experts
                        relatedDestination: 'destination-4' // Montmartre
                      }
                    }
                    -->
                    <div class="bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500 p-4 my-4">
                        <p class="font-semibold">💡 Pro Tip</p>
                        <p>Take the funicular to reach Sacré-Cœur instead of climbing the stairs. It's included with your metro ticket!</p>
                    </div>
                    
                    <h3>Afternoon (2:00 PM - 6:00 PM)</h3>
                    
                    <!-- Split Group Visual Component -->
                    <div class="bg-gradient-to-r from-blue-50 to-green-50 dark:from-blue-900/20 dark:to-green-900/20 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-4 my-4">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                                <span class="font-semibold text-gray-700 dark:text-gray-300">Group Split: Personalized Exploration</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-500">Reunion: 6:00 PM at Café de Flore</span>
                                <button class="btn-icon-sm">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Subgroup 1: Art Lovers -->
                            <div class="bg-white dark:bg-gray-800 rounded-lg p-3 border-l-4 border-blue-500">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="font-semibold text-blue-600 dark:text-blue-400">Art Lovers</h4>
                                    <div class="flex -space-x-2">
                                        <div class="w-6 h-6 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white text-[10px] font-semibold border-2 border-white">SC</div>
                                        <div class="w-6 h-6 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center text-white text-[10px] font-semibold border-2 border-white">MJ</div>
                                    </div>
                                </div>
                                <ul class="space-y-1 text-sm">
                                    <li>• <strong><a href="#" class="text-blue-600 dark:text-blue-400">Musée d'Orsay</a></strong> - Impressionist art (2h)</li>
                                    <li>• <strong><a href="#" class="text-blue-600 dark:text-blue-400">Rodin Museum</a></strong> - Sculptures & gardens (1.5h)</li>
                                </ul>
                                <div class="mt-2 pt-2 border-t border-gray-200 dark:border-gray-700">
                                    <span class="text-xs text-gray-500">💰 €45/person</span>
                                </div>
                            </div>
                            
                            <!-- Subgroup 2: Shopping & Gardens -->
                            <div class="bg-white dark:bg-gray-800 rounded-lg p-3 border-l-4 border-green-500">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="font-semibold text-green-600 dark:text-green-400">Shopping & Gardens</h4>
                                    <div class="flex">
                                        <div class="w-6 h-6 bg-gradient-to-br from-green-500 to-teal-500 rounded-full flex items-center justify-center text-white text-[10px] font-semibold border-2 border-white">EP</div>
                                    </div>
                                </div>
                                <ul class="space-y-1 text-sm">
                                    <li>• <strong><a href="#" class="text-green-600 dark:text-green-400">Le Marais</a></strong> - Boutique shopping (2h)</li>
                                    <li>• <strong><a href="#" class="text-green-600 dark:text-green-400">Luxembourg Gardens</a></strong> - Relaxation (1.5h)</li>
                                </ul>
                                <div class="mt-2 pt-2 border-t border-gray-200 dark:border-gray-700">
                                    <span class="text-xs text-gray-500">💰 €20/person</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Add/Edit Split Group Button -->
                        <div class="mt-3 flex justify-center">
                            <button class="text-xs text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Add another subgroup
                            </button>
                        </div>
                    </div>
                    
                    <h3>Evening (6:00 PM - 9:00 PM)</h3>
                    <ul>
                        <li><strong>Group Reunion</strong> at <a href="#" class="text-pink-600 dark:text-pink-400">Café de Flore</a></li>
                        <li>Share experiences over dinner</li>
                        <li>Traditional French cuisine</li>
                        <li>Evening stroll along the Seine</li>
                    </ul>
                    
                    <!-- 
                    SCHEMA: Split Group Node
                    Represents a point where the group splits into subgroups for parallel activities:
                    {
                      type: 'splitGroup',
                      attrs: {
                        splitId: 'split-1',
                        startTime: '14:00',
                        endTime: '18:00',
                        dayNumber: 2,
                        reunionPoint: {
                          name: 'Café de Flore',
                          coordinates: [48.8542, 2.3333],
                          time: '18:00'
                        },
                        subgroups: [
                          {
                            id: 'subgroup-1',
                            name: 'Art Lovers',
                            participants: ['sarah-chen', 'mike-johnson'],
                            color: '#3B82F6', // Blue for visualization
                            destinations: ['destination-4', 'destination-5'], // References to destination nodes
                            totalCost: 45.00,
                            leadParticipant: 'sarah-chen'
                          },
                          {
                            id: 'subgroup-2',
                            name: 'Shopping & Gardens',
                            participants: ['emma-park'],
                            color: '#10B981', // Green for visualization
                            destinations: ['destination-6', 'destination-7'],
                            totalCost: 20.00,
                            leadParticipant: 'emma-park'
                          }
                        ],
                        notes: 'Group splits after lunch to pursue different interests',
                        createdBy: 'sarah-chen',
                        createdAt: '2024-09-10T14:30:00Z'
                      },
                      content: [...] // Contains the destination nodes for each subgroup
                    }
                    
                    SCHEMA: Transportation Node (Enhanced for Splits)
                    Transportation between destinations, now with participant tracking:
                    {
                      type: 'transportation',
                      attrs: {
                        transportId: 'transport-1',
                        mode: 'metro', // 'walk' | 'metro' | 'bus' | 'taxi' | 'uber' | 'bike'
                        from: { name: 'Eiffel Tower', destinationId: 'destination-1' },
                        to: { name: 'Louvre Museum', destinationId: 'destination-2' },
                        duration: '20 minutes',
                        cost: { amount: 1.90, currency: 'EUR', perPerson: true },
                        participants: null, // null = all, or array of userIds for splits
                        route: {
                          line: 'Line 6 to Line 1',
                          stops: 3,
                          instructions: 'Take Line 6 from Bir-Hakeim to Charles de Gaulle–Étoile, then Line 1 to Palais Royal–Musée du Louvre'
                        },
                        accessibility: {
                          wheelchairAccessible: true,
                          elevatorAvailable: false
                        }
                      }
                    }
                    -->
                </div>
            </div>
        </div>

        <!-- Right Panel - Map View -->
        <!-- 
        SCHEMA: Map Synchronization
        The map view is a visual representation of destination nodes from the TipTap document.
        
        Map State Management:
        - Markers are generated from document.descendants() filtering for type='destination'
        - Each destination.attrs provides:
          * coordinates → marker position on map
          * colorIndex → marker color (consistent with text view)
          * name → marker label
          * booking.status → visual indicator overlay (✓ for booked, ⏳ for pending)
        
        Map-Document Synchronization:
        - Clicking a marker scrolls text view to corresponding destination node
        - Hovering a destination in text highlights marker on map
        - Day filter updates both views simultaneously
        
        View State (stored in doc.attrs.viewPreferences):
        {
          selectedDay: 'all' | 'day-1' | 'day-2' | etc,
          mapBounds: { north, south, east, west }, // Current viewport
          zoomLevel: 12,
          activeMarker: 'destination-1', // Currently selected/hovered
          markerClustering: true // Group nearby markers at low zoom
        }
        
        Real-time Updates:
        - When a destination is added/removed, map updates automatically
        - Booking status changes update marker appearance
        - Collaborator cursors shown as small avatars on map
        -->
        <div :class="viewMode === 'text' ? 'hidden' : (viewMode === 'split' ? 'w-1/2' : 'w-full')" class="relative">
            <!-- Map Container -->
            <div class="w-full h-full relative overflow-hidden bg-gray-100">
                    <!-- Map Controls -->
                    <div class="absolute top-4 right-4 space-y-2">
                        <button class="p-2 bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </button>
                        <button class="p-2 bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Day Selector -->
                    <div class="absolute top-4 left-4">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-2">
                            <select class="px-3 py-2 bg-transparent text-gray-900 dark:text-white focus:outline-none">
                                <option>All Days</option>
                                <option>Day 1: Iconic Landmarks</option>
                                <option>Day 2: Art & Culture</option>
                                <option>Day 3: Versailles</option>
                                <option>Day 4: Hidden Gems</option>
                                <option>Day 5: Shopping & Departure</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Map Grid Pattern -->
                    <div class="absolute inset-0 opacity-10">
                        <div class="h-full w-full" style="background-image: repeating-linear-gradient(0deg, #374151 0px, transparent 1px, transparent 40px, #374151 41px), repeating-linear-gradient(90deg, #374151 0px, transparent 1px, transparent 40px, #374151 41px);"></div>
                    </div>
                    
                    <!-- Map Markers (Simulated) -->
                    <div class="absolute" style="top: 25%; left: 33%;">
                        <div class="relative group">
                            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold shadow-lg animate-pulse cursor-pointer transform hover:scale-110 transition">
                                1
                            </div>
                            <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg p-2 whitespace-nowrap opacity-0 group-hover:opacity-100 transition">
                                <p class="text-xs font-semibold">Eiffel Tower</p>
                                <p class="text-xs text-gray-500">9:00 AM - 12:00 PM</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="absolute" style="top: 33%; left: 66%;">
                        <div class="relative group">
                            <div class="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center text-white font-bold shadow-lg cursor-pointer transform hover:scale-110 transition">
                                2
                            </div>
                            <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg p-2 whitespace-nowrap opacity-0 group-hover:opacity-100 transition">
                                <p class="text-xs font-semibold">Louvre Museum</p>
                                <p class="text-xs text-gray-500">1:00 PM - 5:00 PM</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="absolute" style="top: 66%; left: 50%;">
                        <div class="relative group">
                            <div class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center text-white font-bold shadow-lg cursor-pointer transform hover:scale-110 transition">
                                3
                            </div>
                            <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg p-2 whitespace-nowrap opacity-0 group-hover:opacity-100 transition">
                                <p class="text-xs font-semibold">Seine River</p>
                                <p class="text-xs text-gray-500">6:00 PM - 9:00 PM</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Markers for other locations -->
                    <div class="absolute" style="top: 45%; left: 25%;">
                        <div class="relative group">
                            <div class="w-10 h-10 bg-yellow-600 rounded-full flex items-center justify-center text-white font-bold shadow-lg cursor-pointer transform hover:scale-110 transition">
                                4
                            </div>
                            <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg p-2 whitespace-nowrap opacity-0 group-hover:opacity-100 transition z-10">
                                <p class="text-xs font-semibold">Versailles</p>
                                <p class="text-xs text-gray-500">Day 2 - Morning</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="absolute" style="top: 20%; left: 55%;">
                        <div class="relative group">
                            <div class="w-10 h-10 bg-red-600 rounded-full flex items-center justify-center text-white font-bold shadow-lg cursor-pointer transform hover:scale-110 transition">
                                5
                            </div>
                            <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg p-2 whitespace-nowrap opacity-0 group-hover:opacity-100 transition z-10">
                                <p class="text-xs font-semibold">Montmartre</p>
                                <p class="text-xs text-gray-500">Day 2 - Afternoon</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Route Lines (SVG) -->
                    <svg class="absolute inset-0 w-full h-full pointer-events-none" viewBox="0 0 100 100" preserveAspectRatio="none">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="rgba(59, 130, 246, 0.5)" />
                            </marker>
                        </defs>
                        <path d="M 33 25 Q 50 30 66 33" stroke="rgba(59, 130, 246, 0.5)" stroke-width="0.5" fill="none" stroke-dasharray="1,1" marker-end="url(#arrowhead)">
                            <animate attributeName="stroke-dashoffset" from="0" to="-2" dur="1s" repeatCount="indefinite" />
                        </path>
                        <path d="M 66 33 Q 58 50 50 66" stroke="rgba(59, 130, 246, 0.5)" stroke-width="0.5" fill="none" stroke-dasharray="1,1" marker-end="url(#arrowhead)">
                            <animate attributeName="stroke-dashoffset" from="0" to="-2" dur="1s" repeatCount="indefinite" />
                        </path>
                        <path d="M 50 66 Q 35 55 25 45" stroke="rgba(147, 51, 234, 0.5)" stroke-width="0.5" fill="none" stroke-dasharray="1,1" marker-end="url(#arrowhead)">
                            <animate attributeName="stroke-dashoffset" from="0" to="-2" dur="1s" repeatCount="indefinite" />
                        </path>
                    </svg>
            
                <!-- Floating Place Cards -->
                <!-- 
                SCHEMA: Budget Tracking
                Each day card displays aggregated budget information from destination nodes.
                
                Budget calculation:
                - Iterates through all destination nodes for the day
                - Sums up: booking.price.amount for each destination
                - Adds transportation costs between destinations
                - Displays total cost and duration
                
                Budget Node schema (computed from day's destinations):
                {
                  type: 'dayBudget',
                  attrs: {
                    dayNumber: 1,
                    title: 'Iconic Landmarks',
                    totalHours: 8,
                    totalCost: 113.80,
                    currency: 'EUR',
                    breakdown: [
                      { type: 'destination', name: 'Eiffel Tower', cost: 26.80, status: 'pending' },
                      { type: 'transport', from: 'Eiffel Tower', to: 'Louvre', cost: 1.90 },
                      { type: 'destination', name: 'Louvre Museum', cost: 17.00, status: 'booked' },
                      { type: 'transport', from: 'Louvre', to: 'Seine', cost: 1.90 },
                      { type: 'destination', name: 'Seine River Cruise', cost: 70.00, status: 'pending' }
                    ],
                    bookedAmount: 17.00, // Sum of confirmed bookings
                    pendingAmount: 96.80, // Sum of pending bookings
                    perPerson: true,
                    numberOfTravelers: 2,
                    
                    // Split Group Budget Tracking
                    hasSplits: false, // true if day contains split groups
                    participantCosts: null, // null when no splits, otherwise:
                    /*
                    participantCosts: {
                      'sarah-chen': { 
                        total: 45.00, 
                        destinations: ['Orsay Museum', 'Rodin Museum'],
                        groupName: 'Art Lovers'
                      },
                      'mike-johnson': { 
                        total: 45.00, 
                        destinations: ['Orsay Museum', 'Rodin Museum'],
                        groupName: 'Art Lovers'
                      },
                      'emma-park': { 
                        total: 20.00, 
                        destinations: ['Le Marais', 'Luxembourg Gardens'],
                        groupName: 'Shopping & Gardens'
                      }
                    }
                    */
                  }
                }
                
                Visual indicators:
                - Green checkmark if all bookings confirmed
                - Yellow warning if bookings pending
                - Red alert if approaching budget limit
                -->
                <div class="absolute bottom-4 left-4 right-4 flex space-x-4 overflow-x-auto pb-2">
                    <div class="flex-shrink-0 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 text-xs rounded">Day 1</span>
                            <span class="text-xs text-gray-500">3 places</span>
                        </div>
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-1">Iconic Landmarks</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Eiffel Tower → Louvre → Seine Cruise</p>
                        <div class="mt-3 flex items-center text-xs text-gray-500 dark:text-gray-400">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            8 hours • €113.80
                        </div>
                    </div>
                    
                    <div class="flex-shrink-0 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="px-2 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 text-xs rounded">Day 2</span>
                            <span class="text-xs text-gray-500">4 places</span>
                        </div>
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-1">Art & Culture</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Montmartre → Latin Quarter → Museums</p>
                        <div class="mt-3 flex items-center text-xs text-gray-500 dark:text-gray-400">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            9 hours • €45.00
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Collaboration Panel with Chat -->
    <div x-show="commentsEnabled" x-transition class="fixed bottom-24 right-8 w-96 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 z-30" x-data="{ activeTab: 'chat', showChat: false, currentThread: null, message: '', chatInput: null }">
        <!-- Header with Tabs -->
        <div class="border-b border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between p-4 pb-0">
                <h3 class="font-semibold text-gray-900 dark:text-white">Collaboration</h3>
                <button @click="commentsEnabled = false" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex space-x-1 px-4 mt-2">
                <button @click="activeTab = 'activity'" :class="activeTab === 'activity' ? 'border-b-2 border-black text-gray-900' : 'text-gray-500'" class="px-3 py-2 text-sm font-medium transition">
                    Activity
                </button>
                <button @click="activeTab = 'chat'" :class="activeTab === 'chat' ? 'border-b-2 border-black text-gray-900' : 'text-gray-500'" class="px-3 py-2 text-sm font-medium transition">
                    Chat
                    <span class="ml-1 px-1.5 py-0.5 bg-red-500 text-white text-xs rounded-full">3</span>
                </button>
                <button @click="activeTab = 'threads'" :class="activeTab === 'threads' ? 'border-b-2 border-black text-gray-900' : 'text-gray-500'" class="px-3 py-2 text-sm font-medium transition">
                    Threads
                </button>
            </div>
        </div>
        
        <!-- Activity Tab (existing content) -->
        <div x-show="activeTab === 'activity'" class="p-4">
        
        <!-- Activity Feed -->
        <div class="space-y-3 max-h-64 overflow-y-auto">
            <!-- Comment Activity -->
            <div class="flex items-start gap-3 p-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">
                <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white text-xs font-semibold flex-shrink-0">
                    SC
                </div>
                <div class="flex-1">
                    <p class="text-sm"><span class="font-semibold">Sarah Chen</span> commented on <span class="text-blue-600 dark:text-blue-400">Eiffel Tower timing</span></p>
                    <p class="text-xs text-gray-500">10 min ago</p>
                </div>
            </div>
            
            <!-- Edit Activity -->
            <div class="flex items-start gap-3 p-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">
                <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center text-white text-xs font-semibold flex-shrink-0">
                    MJ
                </div>
                <div class="flex-1">
                    <p class="text-sm"><span class="font-semibold">Mike Johnson</span> suggested extending <span class="text-purple-600 dark:text-purple-400">Louvre visit</span></p>
                    <p class="text-xs text-gray-500">1 hour ago</p>
                </div>
            </div>
            
            <!-- Addition Activity -->
            <div class="flex items-start gap-3 p-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">
                <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-emerald-500 rounded-full flex items-center justify-center text-white text-xs font-semibold flex-shrink-0">
                    EP
                </div>
                <div class="flex-1">
                    <p class="text-sm"><span class="font-semibold">Emma Park</span> added <span class="text-green-600 dark:text-green-400">restaurant recommendation</span></p>
                    <p class="text-xs text-gray-500">2 hours ago</p>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
            <p class="text-xs text-gray-500 mb-2">Quick Actions</p>
            <div class="flex gap-2">
                <button class="flex-1 px-3 py-1 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 text-xs rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30">
                    View All Comments
                </button>
                <button class="flex-1 px-3 py-1 bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 text-xs rounded-lg hover:bg-green-100 dark:hover:bg-green-900/30">
                    Accept Suggestions
                </button>
            </div>
        </div>
        </div>
        
        <!-- Chat Tab -->
        <div x-show="activeTab === 'chat'" class="flex flex-col h-96">
            <!-- Chat Messages -->
            <div class="flex-1 overflow-y-auto p-4 space-y-3">
                <!-- Show existing messages or empty state -->
                <template x-if="$root.chatMessages && $root.chatMessages.length > 0">
                    <template x-for="msg in $root.chatMessages" :key="msg.id">
                        <div class="flex items-start gap-2">
                            <div :class="`w-8 h-8 bg-gradient-to-br ${msg.avatarGradient} rounded-full flex items-center justify-center text-white text-xs font-semibold flex-shrink-0 ${msg.isBot ? 'shadow-md' : ''}`">
                                <span x-text="msg.avatar"></span>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-baseline gap-2 mb-1">
                                    <span class="text-sm font-semibold" x-text="msg.author"></span>
                                    <template x-if="msg.isBot">
                                        <span class="px-1.5 py-0.5 bg-blue-500 text-white text-[10px] rounded font-semibold">AI</span>
                                    </template>
                                    <span class="text-xs text-gray-500" x-text="msg.time"></span>
                                </div>
                                <div :class="msg.isBot ? 'bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3 text-sm' : 'bg-gray-100 dark:bg-gray-700 rounded-lg p-2 text-sm'">
                                    <template x-if="msg.isTyping">
                                        <div class="flex items-center gap-1">
                                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                                        </div>
                                    </template>
                                    <template x-if="!msg.isTyping">
                                        <div x-html="msg.message.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')"></div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                </template>
                
                <!-- Empty state when no messages -->
                <template x-if="!$root.chatMessages || $root.chatMessages.length === 0">
                    <div class="flex flex-col items-center justify-center h-full text-gray-500">
                        <svg class="w-12 h-12 mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <p class="text-sm">No messages yet</p>
                        <p class="text-xs mt-1">Start a conversation or @mention TourVision for help</p>
                    </div>
                </template>
            </div>
            
            <!-- Message Input -->
            <div class="border-t border-gray-200 dark:border-gray-700 p-3">
                <div class="flex items-end gap-2">
                    <button class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                        </svg>
                    </button>
                    <div class="flex-1 relative">
                        <input 
                            type="text" 
                            x-model="message"
                            x-ref="chatInput"
                            placeholder="Type a message... Use @ to mention"
                            class="w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-black"
                            @keyup.enter="if(message.trim()) { $root.chatMessages.push({id: Date.now(), author: 'You', avatar: 'JD', avatarGradient: 'from-indigo-500 to-purple-500', message: message, time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }), isBot: false}); if(message.includes('@TourVision')) { $root.handleBotMention(message); } message = ''; }"
                        >
                        <!-- @mention dropdown -->
                        <div x-show="message && message.includes('@')" class="absolute bottom-full left-0 mb-1 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 p-2 min-w-[200px]">
                            <!-- TourVision AI Bot -->
                            <div class="text-xs text-gray-500 mb-2">AI Assistant</div>
                            <button @click="message = message.substring(0, message.lastIndexOf('@')) + '@TourVision '" class="w-full text-left px-2 py-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center gap-2 text-sm mb-2 border border-blue-200 dark:border-blue-800 bg-blue-50 dark:bg-blue-900/20">
                                <div class="w-6 h-6 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-sm">T</div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-1">
                                        <span class="font-semibold">TourVision</span>
                                        <span class="px-1.5 py-0.5 bg-blue-500 text-white text-[10px] rounded font-semibold">AI</span>
                                    </div>
                                    <div class="text-xs text-gray-500">Ask about bookings, recommendations...</div>
                                </div>
                            </button>
                            
                            <!-- Team Members -->
                            <div class="text-xs text-gray-500 mb-2">Team Members</div>
                            <button @click="message = message.substring(0, message.lastIndexOf('@')) + '@Sarah '" class="w-full text-left px-2 py-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center gap-2 text-sm">
                                <div class="w-6 h-6 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white text-[10px] font-semibold">SC</div>
                                Sarah Chen
                            </button>
                            <button @click="message = message.substring(0, message.lastIndexOf('@')) + '@Mike '" class="w-full text-left px-2 py-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center gap-2 text-sm">
                                <div class="w-6 h-6 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center text-white text-[10px] font-semibold">MJ</div>
                                Mike Johnson
                            </button>
                            <button @click="message = message.substring(0, message.lastIndexOf('@')) + '@Emma '" class="w-full text-left px-2 py-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center gap-2 text-sm">
                                <div class="w-6 h-6 bg-gradient-to-br from-green-500 to-emerald-500 rounded-full flex items-center justify-center text-white text-[10px] font-semibold">EP</div>
                                Emma Park
                            </button>
                        </div>
                    </div>
                    <button class="p-2 bg-black text-white rounded-lg hover:bg-gray-800">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Threads Tab -->
        <div x-show="activeTab === 'threads'" class="p-4">
            <div class="space-y-3 max-h-96 overflow-y-auto">
                <!-- Thread 1: Eiffel Tower Booking -->
                <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                            </svg>
                            <span class="text-sm font-semibold">Eiffel Tower Booking</span>
                            <span class="px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded">Open</span>
                        </div>
                        <span class="text-xs text-gray-500">3 replies</span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Should we book the Eiffel Tower tickets now?</p>
                    <div class="flex items-center gap-2">
                        <div class="flex -space-x-2">
                            <div class="w-6 h-6 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full border-2 border-white"></div>
                            <div class="w-6 h-6 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full border-2 border-white"></div>
                        </div>
                        <span class="text-xs text-gray-500">Sarah, Mike • 10 min ago</span>
                    </div>
                </div>
                
                <!-- Thread 2: Louvre Duration -->
                <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                            <span class="text-sm font-semibold">Louvre Visit Duration</span>
                            <span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded">Suggestion</span>
                        </div>
                        <span class="text-xs text-gray-500">5 replies</span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Suggest extending from 3-4 hours to 4-5 hours</p>
                    <div class="flex items-center gap-2">
                        <div class="flex -space-x-2">
                            <div class="w-6 h-6 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full border-2 border-white"></div>
                            <div class="w-6 h-6 bg-gradient-to-br from-green-500 to-emerald-500 rounded-full border-2 border-white"></div>
                            <div class="w-6 h-6 bg-gray-400 rounded-full border-2 border-white flex items-center justify-center text-[10px] text-white">+1</div>
                        </div>
                        <span class="text-xs text-gray-500">Mike, Emma, You • 1 hour ago</span>
                    </div>
                </div>
                
                <!-- Thread 3: Restaurant Recommendation -->
                <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            <span class="text-sm font-semibold">Restaurant Near Louvre</span>
                            <span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded">Resolved</span>
                        </div>
                        <span class="text-xs text-gray-500">8 replies</span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">L'Ardoise restaurant recommendation added</p>
                    <div class="flex items-center gap-2">
                        <div class="flex -space-x-2">
                            <div class="w-6 h-6 bg-gradient-to-br from-green-500 to-emerald-500 rounded-full border-2 border-white"></div>
                            <div class="w-6 h-6 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full border-2 border-white"></div>
                        </div>
                        <span class="text-xs text-gray-500">Emma, Sarah • 2 hours ago</span>
                    </div>
                </div>
            </div>
            
            <!-- Start New Thread Button -->
            <button class="w-full mt-3 px-3 py-2 bg-black text-white text-sm rounded-lg hover:bg-gray-800 flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Start New Thread
            </button>
        </div>
    </div>
    
    <!-- Floating Action Button -->
    <div class="fixed bottom-8 right-8">
        <button class="w-14 h-14 bg-black text-white rounded-full shadow-lg hover:shadow-xl hover:bg-gray-800 transition flex items-center justify-center">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
        </button>
    </div>

    <script>
        /*
        ==========================================
        PERSISTENCE LAYER & SYNC STRATEGY
        ==========================================
        
        The TipTap document is persisted and synchronized using the following strategy:
        
        1. LOCAL STORAGE (Immediate persistence):
           - Key: 'itinerary:{tripId}:document' - Full TipTap document JSON
           - Key: 'itinerary:{tripId}:view' - View preferences (mode, filters)
           - Key: 'itinerary:{tripId}:offline-queue' - Pending changes when offline
           - Saved on every transaction using debounced save (500ms)
        
        2. DATABASE PERSISTENCE:
           - PostgreSQL via Prisma ORM
           - Document stored as JSONB in 'documents' table
           - Each save creates a new version for history
           - Metadata indexed for fast queries
        
        3. REAL-TIME SYNC (WebSocket):
           - Powered by Y.js for Conflict-free Replicated Data Types (CRDT)
           - Each change broadcasts as Y.js update
           - Automatic conflict resolution
           - Presence information (cursors, selections)
        
        4. OPTIMISTIC UPDATES:
           - Changes applied immediately to local document
           - Queued for server sync
           - On success: confirmed
           - On failure: rollback with user notification
        
        5. OFFLINE SUPPORT:
           - All changes queued in IndexedDB
           - Sync attempted on reconnection
           - Conflict resolution UI if needed
           - Manual merge option for complex conflicts
        
        6. CHANGE TRACKING:
           Transaction metadata includes:
           {
             userId: 'current-user',
             timestamp: ISO timestamp,
             type: 'edit' | 'comment' | 'booking' | 'suggestion',
             nodeId: affected node,
             previousValue: for undo support,
             newValue: current value
           }
        
        7. DATA FLOW:
           User Action → TipTap Transaction → Local Save → Queue Sync → 
           WebSocket Broadcast → Server Validation → Database Write → 
           Broadcast to Collaborators → Update UI
        
        8. BACKUP STRATEGY:
           - Auto-save every 30 seconds
           - Export to JSON/PDF available
           - Version history with restore points
           - Incremental backups to cloud storage
        */
        
        function collaborationFeatures() {
            return {
                commentsEnabled: false,
                editingEnabled: false,
                showCommentButton: false,
                commentButtonPosition: { top: 0, left: 0 },
                comments: [
                    {
                        id: 1,
                        author: 'Sarah Chen',
                        text: 'Should we book the Eiffel Tower tickets now? They might sell out.',
                        time: '10 min ago',
                        position: 200,
                        resolved: false
                    },
                    {
                        id: 2,
                        author: 'Mike Johnson',
                        text: 'I suggest adding more time at the Louvre - 3 hours might be too short.',
                        suggestion: 'Change duration to 4-5 hours to see more exhibits',
                        time: '1 hour ago',
                        position: 350,
                        resolved: false
                    }
                ],
                activeComment: null,
                selectedText: '',
                
                // Chat and bot functionality
                chatMessages: [],
                
                // Demo scenarios for prototype
                demoScenarios: {
                    fastfood: {
                        trigger: '@tourvision find a place to get some fastfood on our way to eiffel tower',
                        messages: [
                            {
                                delay: 0,
                                author: 'You',
                                avatar: 'JD',
                                avatarGradient: 'from-indigo-500 to-purple-500',
                                message: '@TourVision find a place to get some fastfood on our way to Eiffel Tower',
                                isBot: false
                            },
                            {
                                delay: 1500,
                                author: 'TourVision',
                                avatar: 'T',
                                avatarGradient: 'from-blue-500 to-purple-600',
                                message: '🍔 **Quick food options on your way to the Eiffel Tower:**\n\n**McDonald\'s Champs de Mars** (5 min walk)\n📍 45 Avenue de la Bourdonnais\n• Open until 11 PM\n• McBaguette (local specialty): €8.50\n• Quick service, outdoor seating\n\n**Five Guys** (7 min walk)\n📍 17 Rue de l\'Université\n• Fresh burgers & fries\n• Burger + fries: €15-18\n• Known for generous portions\n\n**Prêt à Manger** (3 min walk)\n📍 80 Avenue Bosquet\n• Sandwiches, salads, wraps\n• Meal deal: €8-12\n• Healthy quick options\n\n💡 **Pro tip**: Grab food from Prêt à Manger - it\'s closest to your route and you can eat while walking to save time!',
                                isBot: true,
                                responseType: 'recommendation'
                            }
                        ]
                    },
                    transport: {
                        trigger: '@tourvision how long to get from louvre to eiffel tower',
                        messages: [
                            {
                                delay: 0,
                                author: 'You',
                                avatar: 'JD',
                                avatarGradient: 'from-indigo-500 to-purple-500',
                                message: '@TourVision how long to get from Louvre to Eiffel Tower?',
                                isBot: false
                            },
                            {
                                delay: 1200,
                                author: 'TourVision',
                                avatar: 'T',
                                avatarGradient: 'from-blue-500 to-purple-600',
                                message: '🚇 **Getting from Louvre to Eiffel Tower:**\n\n**By Metro** (Fastest - 20 min)\n• Take Line 1 from Palais Royal\n• Change at Champs-Élysées\n• Take Line 6 to Bir-Hakeim\n• 5 min walk to tower\n• Cost: €2.15\n\n**By Walking** (45-50 min)\n• Beautiful route along the Seine\n• Pass by Musée d\'Orsay\n• Great photo opportunities\n• Free!\n\n**By Taxi/Uber** (15 min)\n• €12-18 depending on traffic\n• Drop-off at Avenue Gustave Eiffel\n\n💡 **My recommendation**: Walk if weather is nice - the riverside path is gorgeous and you\'ll discover hidden gems along the way!',
                                isBot: true,
                                responseType: 'logistics'
                            }
                        ]
                    },
                    photoSpots: {
                        trigger: '@tourvision any good photo spots near the seine',
                        messages: [
                            {
                                delay: 0,
                                author: 'Emma Park',
                                avatar: 'EP',
                                avatarGradient: 'from-green-500 to-emerald-500',
                                message: '@TourVision any good photo spots near the Seine?',
                                isBot: false
                            },
                            {
                                delay: 1800,
                                author: 'TourVision',
                                avatar: 'T',
                                avatarGradient: 'from-blue-500 to-purple-600',
                                message: '📸 **Best photo spots along the Seine:**\n\n**Pont Alexandre III** ⭐⭐⭐⭐⭐\n• Most ornate bridge in Paris\n• Golden statues & Art Nouveau lamps\n• Best at golden hour (7-8 PM)\n\n**Trocadéro Gardens**\n• Iconic Eiffel Tower view\n• Best at sunrise (fewer crowds)\n• Fountain shows every hour\n\n**Pont de Bir-Hakeim**\n• Two-level bridge, great architecture\n• Featured in Inception movie\n• Metro trains add drama to shots\n\n**Square du Vert-Galant**\n• Tip of Île de la Cité\n• 360° river views\n• Perfect for sunset pics\n\n🌅 **Golden hour times this week:**\n• Morning: 7:15-8:00 AM\n• Evening: 7:30-8:15 PM\n\n💡 **Pro photographer tip**: Bring a polarizing filter to reduce glare off the water!',
                                isBot: true,
                                responseType: 'recommendation'
                            }
                        ]
                    }
                },
                
                // Flag to track if we're playing a demo
                isPlayingDemo: false,
                
                selectMention(mention) {
                    // Replace @mention trigger with selected mention
                    // Find the chat panel's message input
                    const chatPanel = document.querySelector('[x-show="commentsEnabled"]');
                    if (chatPanel) {
                        const messageData = chatPanel.__x.$data;
                        const currentValue = messageData.message;
                        const atIndex = currentValue.lastIndexOf('@');
                        messageData.message = currentValue.substring(0, atIndex) + mention + ' ';
                        
                        // Check if bot was mentioned and focus input
                        const input = chatPanel.querySelector('input[x-ref="chatInput"]');
                        if (input) {
                            input.focus();
                        }
                    }
                },
                
                sendChatMessage() {
                    // Get message from chat panel scope
                    const chatPanel = document.querySelector('[x-show="commentsEnabled"]');
                    if (!chatPanel) return;
                    
                    const messageData = chatPanel.__x.$data;
                    const messageText = messageData.message;
                    
                    if (!messageText.trim()) return;
                    
                    // Check if this matches a demo scenario
                    const lowerMessage = messageText.toLowerCase().trim();
                    let scenarioMatched = false;
                    
                    for (const [key, scenario] of Object.entries(this.demoScenarios)) {
                        if (lowerMessage === scenario.trigger.toLowerCase()) {
                            this.playDemoScenario(key);
                            messageData.message = '';
                            scenarioMatched = true;
                            break;
                        }
                    }
                    
                    // If no demo scenario matched, handle as normal message
                    if (!scenarioMatched) {
                        // Add user message
                        const userMessage = {
                            id: this.chatMessages.length + 1,
                            author: 'You',
                            avatar: 'JD',
                            avatarGradient: 'from-indigo-500 to-purple-500',
                            message: messageText,
                            time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }),
                            isBot: false
                        };
                        
                        this.chatMessages.push(userMessage);
                        
                        // Check if TourVision was mentioned
                        if (messageText.includes('@TourVision') || messageText.includes('@tourvision')) {
                            this.handleBotMention(messageText);
                        }
                        
                        // Clear input
                        messageData.message = '';
                    }
                },
                
                playDemoScenario(scenarioKey) {
                    if (this.isPlayingDemo) return;
                    this.isPlayingDemo = true;
                    
                    const scenario = this.demoScenarios[scenarioKey];
                    if (!scenario) return;
                    
                    // Play each message with delays
                    scenario.messages.forEach((msg, index) => {
                        setTimeout(() => {
                            const message = {
                                id: this.chatMessages.length + 1,
                                author: msg.author,
                                avatar: msg.avatar,
                                avatarGradient: msg.avatarGradient,
                                message: msg.message,
                                time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }),
                                isBot: msg.isBot,
                                responseType: msg.responseType
                            };
                            this.chatMessages.push(message);
                            
                            // Reset flag after last message
                            if (index === scenario.messages.length - 1) {
                                setTimeout(() => {
                                    this.isPlayingDemo = false;
                                }, 500);
                            }
                        }, msg.delay);
                    });
                },
                
                handleBotMention(message) {
                    // Show typing indicator
                    const typingIndicator = {
                        id: 'typing-' + Date.now(),
                        author: 'TourVision',
                        avatar: 'T',
                        avatarGradient: 'from-blue-500 to-purple-600',
                        message: 'typing',
                        isTyping: true,
                        isBot: true
                    };
                    this.chatMessages.push(typingIndicator);
                    
                    // Simulate response delay then replace typing with actual message
                    setTimeout(() => {
                        // Remove typing indicator
                        const typingIndex = this.chatMessages.findIndex(msg => msg.id === typingIndicator.id);
                        if (typingIndex > -1) {
                            this.chatMessages.splice(typingIndex, 1);
                        }
                        
                        // Check for split group keywords
                        const lowerMessage = message.toLowerCase();
                        let botResponse;
                        
                        if (lowerMessage.includes('split') || lowerMessage.includes('different') || 
                            lowerMessage.includes('separate') || lowerMessage.includes('branch')) {
                            // Generate split group response
                            const splitResponses = this.generateBotResponse(message).split.messages;
                            const randomResponse = splitResponses[Math.floor(Math.random() * splitResponses.length)];
                            
                            botResponse = {
                                id: Date.now(),
                                author: 'TourVision',
                                avatar: 'T',
                                avatarGradient: 'from-blue-500 to-purple-600',
                                message: randomResponse,
                                time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }),
                                isBot: true,
                                hasActions: true,
                                actions: [
                                    { 
                                        label: 'Create Split Group', 
                                        onclick: 'this.createSplitGroup(2, {start: "14:00", end: "18:00"})' 
                                    },
                                    { 
                                        label: 'View Interests', 
                                        onclick: 'alert("Sarah: Art & Museums\\nMike: History & Architecture\\nEmma: Shopping & Cafes")' 
                                    }
                                ]
                            };
                        } else {
                            // Generate regular response
                            botResponse = this.generateBotResponse(message);
                        }
                        
                        this.chatMessages.push(botResponse);
                    }, 1500);
                },
                
                generateBotResponse(userMessage) {
                    const responses = {
                        booking: {
                            type: 'booking',
                            messages: [
                                'I can help you book tickets! Here are the current availability and prices:\n\n🎫 **Eiffel Tower**\n• Summit: €28.30\n• 2nd Floor: €18.10\n• Available slots today: 2:00 PM, 4:30 PM\n\n🎨 **Louvre Museum**\n• General: €17\n• Free for under 18\n• Next available: Tomorrow 10:00 AM\n\nWould you like me to reserve any of these?',
                                'Great timing! I found these booking options:\n\n✨ **Skip-the-line tickets available**\n• Eiffel Tower Summit: 3:00 PM slot\n• Includes audio guide\n• Price: €35 per person\n\n📱 **Mobile tickets** - No printing needed!\n\nShall I proceed with the booking?'
                            ]
                        },
                        split: {
                            type: 'split_suggestion',
                            messages: [
                                '👥 **I noticed your group has different interests for the afternoon!**\n\nBased on your preferences:\n\n**Art Enthusiasts** (Sarah & Mike)\n🎨 Musée d\'Orsay (2h) → Rodin Museum (1.5h)\n💰 Total: €45/person\n❤️ Interests: Impressionist art, sculptures\n\n**Shopping & Relaxation** (Emma)\n🛍️ Le Marais boutiques (2h) → Luxembourg Gardens (1.5h)\n💰 Total: €20/person\n✨ Interests: Fashion, gardens, cafes\n\n**Reunion Point**: Café de Flore at 6:00 PM\n\nWould you like me to create this split in your itinerary?',
                                '🌟 **Perfect time to split the group!**\n\nI\'ve analyzed everyone\'s preferences:\n\n**Option A: Culture & History**\n🏛️ Panthéon → Sainte-Chapelle\n👥 Best for: Sarah (loves architecture)\n⏰ Duration: 3 hours\n\n**Option B: Active Exploration**\n🚴 Bike tour along the Seine\n👥 Best for: Mike (enjoys outdoor activities)\n⏰ Duration: 2.5 hours\n\n**Option C: Local Experience**\n☕ Saint-Germain cafes → Antique markets\n👥 Best for: Emma (foodie & shopping)\n⏰ Duration: 3 hours\n\nSuggested reunion: 5:30 PM at Pont Neuf\n\nShall I organize these personalized routes?'
                            ]
                        },
                        fastfood: {
                            type: 'recommendation',
                            messages: [
                                '🍔 **Quick food options on your way to the Eiffel Tower:**\n\n**McDonald\'s Champs de Mars** (5 min walk)\n📍 45 Avenue de la Bourdonnais\n• Open until 11 PM\n• McBaguette (local specialty): €8.50\n• Quick service, outdoor seating\n\n**Five Guys** (7 min walk)\n📍 17 Rue de l\'Université\n• Fresh burgers & fries\n• Burger + fries: €15-18\n• Known for generous portions\n\n**Prêt à Manger** (3 min walk)\n📍 80 Avenue Bosquet\n• Sandwiches, salads, wraps\n• Meal deal: €8-12\n• Healthy quick options\n\n💡 **Pro tip**: Grab food from Prêt à Manger - it\'s closest to your route and you can eat while walking to save time!',
                                '🥪 **Fast food near your current location:**\n\n**Subway** (4 min walk)\n📍 23 Avenue de Tourville\n• Custom sandwiches\n• Footlong meal: €9-12\n• Vegetarian options available\n\n**Burger King** (6 min walk)\n📍 2 Place Joffre\n• Whopper meal: €10.90\n• Open until midnight\n• Mobile ordering available\n\n**Paul Bakery** (2 min walk)\n📍 89 Rue Saint-Dominique\n• Fresh sandwiches & pastries\n• Quick lunch formula: €7.50\n• Perfect for grab-and-go\n\n⏰ **Time saver**: Paul Bakery is super quick - perfect since you need to reach the Eiffel Tower by 9:00 AM!'
                            ]
                        },
                        restaurant: {
                            type: 'recommendation',
                            messages: [
                                'Based on your location near the Eiffel Tower, here are my top picks:\n\n🍽️ **Le Jules Verne** (In Eiffel Tower)\n⭐ Michelin 2-star, French haute cuisine\n💰 €190-320 per person\n\n🥖 **Café de l\'Homme** (Trocadéro)\n⭐ 4.5/5 • Great tower views\n💰 €45-80 per person\n\n🍷 **L\'Ami Jean** (15 min walk)\n⭐ Bistro, local favorite\n💰 €35-50 per person\n\nNeed reservations?',
                                'I found these highly-rated restaurants:\n\n🥐 **For breakfast**: Carette (Trocadéro)\n• Famous for pastries\n• Opens at 7:30 AM\n\n🍝 **For lunch**: Chez Janou\n• Provençal cuisine\n• Great prix fixe menu: €24\n\n🍾 **For dinner**: Le Comptoir du Relais\n• Traditional French\n• Book 2 weeks ahead!\n\nWant me to check availability?'
                            ]
                        },
                        transportation: {
                            type: 'logistics',
                            messages: [
                                '🚇 **Getting around Paris efficiently:**\n\n**Metro Pass Options:**\n• Day pass: €8.45\n• 3-day pass: €20.10\n• Week pass: €30\n\n**From your hotel to main attractions:**\n• Eiffel Tower: Line 6 (Bir-Hakeim)\n• Louvre: Line 1 (Palais Royal)\n• Arc de Triomphe: Line 1, 2, 6 (Charles de Gaulle)\n\n💡 Download the Citymapper app for real-time directions!',
                                '🚕 **Transportation options from CDG Airport:**\n\n**RER B Train** (Fastest)\n• €11.45 per person\n• 35-40 minutes\n• Runs every 10-15 min\n\n**Taxi**\n• Fixed rate: €55 (Right Bank), €65 (Left Bank)\n• 45-60 minutes\n\n**Private transfer**\n• €70-90\n• Meet & greet included\n\nWhich option works best for your arrival time?'
                            ]
                        },
                        weather: {
                            type: 'info',
                            messages: [
                                '☀️ **Paris Weather Forecast:**\n\n**Next 3 days:**\n• Today: 22°C, Partly cloudy\n• Tomorrow: 24°C, Sunny\n• Day 3: 20°C, Light rain (afternoon)\n\n**What to pack:**\n• Light layers for day\n• Jacket for evenings (15°C)\n• Umbrella for Day 3\n• Comfortable walking shoes\n\n🌅 Sunrise: 6:45 AM | 🌇 Sunset: 8:30 PM',
                                '🌦️ **Weather update for your trip dates:**\n\n**September 15-19:**\n• Avg high: 21°C\n• Avg low: 13°C\n• Rain chance: 30%\n\n**Best outdoor times:**\n• Morning: 10 AM - 12 PM\n• Late afternoon: 4 PM - 7 PM\n\n**Indoor alternatives for rainy days:**\n• Morning: Museums\n• Afternoon: Shopping galleries\n• Evening: Shows & concerts'
                            ]
                        },
                        general: {
                            type: 'assistant',
                            messages: [
                                'I\'m here to help with your Paris trip! I can assist with:\n\n📍 **Recommendations**: Restaurants, attractions, hidden gems\n🎫 **Bookings**: Tickets, tours, restaurants\n🚇 **Transportation**: Routes, passes, transfers\n⏰ **Scheduling**: Optimize your itinerary\n💰 **Budgeting**: Cost estimates, money-saving tips\n🌦️ **Weather**: Forecasts and what to pack\n\nWhat would you like help with?',
                                'Great question! Let me help you with that.\n\nBased on your itinerary, I can:\n• Find available tickets\n• Suggest route optimizations\n• Recommend nearby attractions\n• Book restaurants\n• Provide real-time updates\n\nWhat specific aspect would you like me to focus on?'
                            ]
                        }
                    };
                    
                    // Determine response type based on keywords
                    let responseCategory = 'general';
                    const lowerMessage = userMessage.toLowerCase();
                    
                    if (lowerMessage.includes('book') || lowerMessage.includes('ticket') || lowerMessage.includes('reserve')) {
                        responseCategory = 'booking';
                    } else if (lowerMessage.includes('fastfood') || lowerMessage.includes('fast food') || lowerMessage.includes('quick bite') || lowerMessage.includes('burger') || lowerMessage.includes('sandwich') || lowerMessage.includes('mcdonald')) {
                        responseCategory = 'fastfood';
                    } else if (lowerMessage.includes('restaurant') || lowerMessage.includes('eat') || lowerMessage.includes('food') || lowerMessage.includes('lunch') || lowerMessage.includes('dinner')) {
                        responseCategory = 'restaurant';
                    } else if (lowerMessage.includes('metro') || lowerMessage.includes('transport') || lowerMessage.includes('get to') || lowerMessage.includes('taxi') || lowerMessage.includes('airport')) {
                        responseCategory = 'transportation';
                    } else if (lowerMessage.includes('weather') || lowerMessage.includes('rain') || lowerMessage.includes('temperature') || lowerMessage.includes('pack')) {
                        responseCategory = 'weather';
                    } else if (lowerMessage.includes('crowd') || lowerMessage.includes('busy') || lowerMessage.includes('best time')) {
                        responseCategory = 'recommendation';
                    }
                    
                    const category = responses[responseCategory] || responses.general;
                    const randomMessage = category.messages[Math.floor(Math.random() * category.messages.length)];
                    
                    return {
                        id: this.chatMessages.length + 1,
                        author: 'TourVision',
                        avatar: 'T',
                        avatarGradient: 'from-blue-500 to-purple-600',
                        message: randomMessage,
                        time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }),
                        isBot: true,
                        responseType: category.type
                    };
                },
                
                handleTextSelection(event) {
                    const selection = window.getSelection();
                    const text = selection.toString().trim();
                    
                    if (text && this.commentsEnabled) {
                        this.selectedText = text;
                        const range = selection.getRangeAt(0);
                        const rect = range.getBoundingClientRect();
                        const container = event.currentTarget.getBoundingClientRect();
                        
                        this.commentButtonPosition = {
                            top: rect.top - container.top + rect.height + 5,
                            left: rect.left - container.left
                        };
                        this.showCommentButton = true;
                    } else {
                        this.showCommentButton = false;
                    }
                },
                
                handleLineClick(event) {
                    // Find if click is near a comment indicator
                    const clickY = event.clientY;
                    const container = event.currentTarget.getBoundingClientRect();
                    const relativeY = clickY - container.top;
                    
                    // Check if click is near any comment
                    const nearbyComment = this.comments.find(c => 
                        Math.abs(c.position - relativeY) < 30
                    );
                    
                    if (nearbyComment) {
                        this.selectComment(nearbyComment);
                    }
                },
                
                addComment() {
                    const newComment = {
                        id: Date.now(),
                        author: 'You',
                        text: prompt('Add your comment:'),
                        time: 'Just now',
                        position: this.commentButtonPosition.top,
                        selectedText: this.selectedText,
                        resolved: false
                    };
                    
                    if (newComment.text) {
                        this.comments.push(newComment);
                        this.activeComment = newComment;
                        this.showCommentButton = false;
                    }
                },
                
                selectComment(comment) {
                    this.activeComment = comment;
                    // Highlight the relevant text in the editor
                    // This would integrate with the actual editor
                },
                
                acceptSuggestion(comment) {
                    // Apply the suggestion to the document
                    alert('Suggestion accepted and applied to the document');
                    comment.resolved = true;
                    this.activeComment = null;
                },
                
                rejectSuggestion(comment) {
                    comment.resolved = true;
                    this.activeComment = null;
                },
                
                toggleComments() {
                    // Toggle comment visibility
                },
                
                toggleEditing() {
                    // Toggle editing permissions
                },
                
                shareWithLink() {
                    const link = window.location.href + '?share=' + Date.now();
                    navigator.clipboard.writeText(link);
                    alert('Shareable link copied to clipboard!');
                },
                
                inviteCollaborator() {
                    const email = prompt('Enter collaborator email:');
                    if (email) {
                        alert(`Invitation sent to ${email}`);
                    }
                }
            }
        }
        
        function itineraryBuilder() {
            return {
                viewMode: 'split',
                selectedDay: 'all',
                itineraryData: null,
                commentsEnabled: false,
                editingEnabled: false,
                splitGroups: [],
                showSplitModal: false,
                currentSplit: null,
                
                init() {
                    
                    // Load itinerary data from localStorage
                    const storedData = localStorage.getItem('currentItinerary');
                    if (storedData) {
                        this.itineraryData = JSON.parse(storedData);
                        this.updatePageWithData();
                    }
                },
                
                updatePageWithData() {
                    if (!this.itineraryData) return;
                    
                    // Update the header title
                    const titleElement = document.querySelector('h1');
                    if (titleElement) {
                        titleElement.textContent = `${this.itineraryData.destination} Adventure - ${this.itineraryData.duration}`;
                    }
                    
                    // Update the editor content with the itinerary data
                    this.generateItineraryContent();
                },
                
                generateItineraryContent() {
                    const editorContent = document.querySelector('[contenteditable]');
                    if (!editorContent || !this.itineraryData) return;
                    
                    let html = `
                        <h1>${this.itineraryData.destination} Adventure Itinerary</h1>
                        <p class="lead">${this.itineraryData.duration} exploring the City of Light - ${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</p>
                    `;
                    
                    this.itineraryData.days.forEach((day, index) => {
                        if (day.places.length === 0) return;
                        
                        html += `<h2>${day.name}: ${this.getDayTheme(index)}</h2>`;
                        
                        // Group places by time of day
                        const morning = day.places.slice(0, Math.ceil(day.places.length / 3));
                        const afternoon = day.places.slice(Math.ceil(day.places.length / 3), Math.ceil(day.places.length * 2 / 3));
                        const evening = day.places.slice(Math.ceil(day.places.length * 2 / 3));
                        
                        if (morning.length > 0) {
                            html += `<h3>Morning (9:00 AM - 12:00 PM)</h3><ul>`;
                            morning.forEach(place => {
                                html += `<li><strong><a href="#" class="text-blue-600 dark:text-blue-400">${place.name}</a></strong> - ${this.getPlaceDescription(place.name)}</li>`;
                            });
                            html += `</ul>`;
                        }
                        
                        if (afternoon.length > 0) {
                            html += `<h3>Afternoon (1:00 PM - 5:00 PM)</h3><ul>`;
                            afternoon.forEach(place => {
                                html += `<li><strong><a href="#" class="text-purple-600 dark:text-purple-400">${place.name}</a></strong> - ${this.getPlaceDescription(place.name)}</li>`;
                            });
                            html += `</ul>`;
                        }
                        
                        if (evening.length > 0) {
                            html += `<h3>Evening (6:00 PM - 9:00 PM)</h3><ul>`;
                            evening.forEach(place => {
                                html += `<li><strong><a href="#" class="text-green-600 dark:text-green-400">${place.name}</a></strong> - ${this.getPlaceDescription(place.name)}</li>`;
                            });
                            html += `</ul>`;
                        }
                        
                        // Add a tip box for some days
                        if (index === 0) {
                            html += `
                                <div class="bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500 p-4 my-4">
                                    <p class="font-semibold">💡 Pro Tip</p>
                                    <p>Book skip-the-line tickets in advance for popular attractions to save time!</p>
                                </div>
                            `;
                        }
                    });
                    
                    editorContent.innerHTML = html;
                },
                
                getDayTheme(index) {
                    const themes = ['Iconic Landmarks', 'Art & Culture', 'Royal Palace & Gardens', 'Hidden Gems', 'Shopping & Farewell'];
                    return themes[index] || 'Exploration Day';
                },
                
                getPlaceDescription(placeName) {
                    const descriptions = {
                        'Eiffel Tower': 'Iconic iron lattice tower with panoramic city views',
                        'Louvre Museum': "World's largest art museum and historic monument",
                        'Seine River Cruise': 'Scenic boat tour along Paris\'s famous river',
                        'Versailles': 'Opulent royal palace with stunning gardens',
                        'Montmartre': 'Historic artistic neighborhood with charming streets',
                        'Sacré-Cœur': 'Beautiful basilica with breathtaking city views',
                        'Latin Quarter': 'Vibrant student district with bookshops and cafés',
                        'Notre-Dame': 'Gothic cathedral masterpiece (exterior viewing)',
                        'Arc de Triomphe': 'Triumphal arch honoring French victories',
                        'Musée d\'Orsay': 'Impressionist art in a beautiful Beaux-Arts station',
                        'Champs-Élysées': 'Famous avenue for shopping and strolling',
                        'Marais District': 'Trendy neighborhood with boutiques and galleries'
                    };
                    return descriptions[placeName] || 'A must-visit destination in Paris';
                },
                
                // Split Group Management Functions
                createSplitGroup(dayNumber, timeSlot) {
                    const collaborators = [
                        { userId: 'sarah-chen', name: 'Sarah Chen', color: '#8B5CF6' },
                        { userId: 'mike-johnson', name: 'Mike Johnson', color: '#3B82F6' },
                        { userId: 'emma-park', name: 'Emma Park', color: '#10B981' }
                    ];
                    
                    this.currentSplit = {
                        splitId: `split-${Date.now()}`,
                        dayNumber: dayNumber,
                        startTime: timeSlot.start,
                        endTime: timeSlot.end,
                        reunionPoint: {
                            name: '',
                            time: timeSlot.end,
                            coordinates: null
                        },
                        subgroups: [
                            {
                                id: `subgroup-1`,
                                name: 'Group 1',
                                participants: [],
                                destinations: [],
                                color: '#3B82F6'
                            },
                            {
                                id: `subgroup-2`,
                                name: 'Group 2',
                                participants: [],
                                destinations: [],
                                color: '#10B981'
                            }
                        ],
                        collaborators: collaborators
                    };
                    
                    this.showSplitModal = true;
                },
                
                assignParticipant(participantId, subgroupId) {
                    if (!this.currentSplit) return;
                    
                    // Remove participant from all subgroups first
                    this.currentSplit.subgroups.forEach(group => {
                        group.participants = group.participants.filter(p => p !== participantId);
                    });
                    
                    // Add to selected subgroup
                    const subgroup = this.currentSplit.subgroups.find(g => g.id === subgroupId);
                    if (subgroup) {
                        subgroup.participants.push(participantId);
                    }
                },
                
                addSubgroup() {
                    if (!this.currentSplit) return;
                    
                    const colors = ['#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#06B6D4'];
                    const newGroupNum = this.currentSplit.subgroups.length + 1;
                    
                    this.currentSplit.subgroups.push({
                        id: `subgroup-${newGroupNum}`,
                        name: `Group ${newGroupNum}`,
                        participants: [],
                        destinations: [],
                        color: colors[(newGroupNum - 1) % colors.length]
                    });
                },
                
                removeSubgroup(subgroupId) {
                    if (!this.currentSplit || this.currentSplit.subgroups.length <= 2) return;
                    
                    this.currentSplit.subgroups = this.currentSplit.subgroups.filter(g => g.id !== subgroupId);
                },
                
                saveSplitGroup() {
                    if (!this.currentSplit) return;
                    
                    // Validate that all participants are assigned
                    const allAssigned = this.currentSplit.collaborators.every(collab => 
                        this.currentSplit.subgroups.some(group => 
                            group.participants.includes(collab.userId)
                        )
                    );
                    
                    if (!allAssigned) {
                        alert('Please assign all participants to a subgroup');
                        return;
                    }
                    
                    // Add to split groups list
                    this.splitGroups.push(this.currentSplit);
                    
                    // Update the document (in real implementation, would update TipTap)
                    this.updateSplitGroupInDocument();
                    
                    // Close modal
                    this.showSplitModal = false;
                    this.currentSplit = null;
                },
                
                updateSplitGroupInDocument() {
                    // This would integrate with TipTap to insert the split group node
                    console.log('Split group created:', this.currentSplit);
                    
                    // Show visual feedback
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                    notification.textContent = 'Split group created successfully!';
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                },
                
                calculateSplitCosts(subgroup) {
                    // Calculate total cost for subgroup based on destinations
                    let total = 0;
                    subgroup.destinations.forEach(destId => {
                        // In real implementation, would look up destination costs
                        total += 20; // Placeholder cost
                    });
                    return total;
                },
                
                suggestSplitGroups() {
                    // AI-powered suggestion for split groups based on interests
                    const suggestions = [
                        {
                            name: 'Art & Museums',
                            interests: ['art', 'history', 'culture'],
                            destinations: ['Musée d\'Orsay', 'Rodin Museum']
                        },
                        {
                            name: 'Shopping & Cafes',
                            interests: ['shopping', 'food', 'relaxation'],
                            destinations: ['Le Marais', 'Latin Quarter']
                        },
                        {
                            name: 'Adventure & Activities',
                            interests: ['outdoor', 'sports', 'adventure'],
                            destinations: ['Bike Tour', 'Seine Kayaking']
                        }
                    ];
                    
                    return suggestions;
                }
            }
        }
    </script>

    <!-- Split Group Creation Modal -->
    <div x-show="showSplitModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div @click.outside="showSplitModal = false" class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <!-- Modal Header -->
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Create Split Group</h2>
                    <button @click="showSplitModal = false" class="btn-icon">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Modal Body -->
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-180px)]">
                <!-- Time and Reunion Settings -->
                <div class="mb-6">
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-3">Split Details</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Start Time</label>
                            <input type="time" x-model="currentSplit.startTime" class="input-text w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">End Time</label>
                            <input type="time" x-model="currentSplit.endTime" class="input-text w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Reunion Point</label>
                            <input type="text" placeholder="e.g., Café de Flore" x-model="currentSplit.reunionPoint.name" class="input-text w-full">
                        </div>
                    </div>
                </div>
                
                <!-- Participant Assignment -->
                <div class="mb-6">
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-3">Assign Participants to Groups</h3>
                    
                    <!-- Unassigned Participants -->
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Drag participants to assign them to groups:</p>
                        <div class="flex gap-2 flex-wrap p-3 bg-gray-50 dark:bg-gray-900 rounded-lg min-h-[60px]">
                            <template x-for="collab in currentSplit?.collaborators || []" :key="collab.userId">
                                <template x-if="!currentSplit.subgroups.some(g => g.participants.includes(collab.userId))">
                                    <div class="participant-chip" draggable="true" :data-participant-id="collab.userId"
                                         :style="`background: ${collab.color};`">
                                        <span class="text-white text-sm font-medium">{{ collab.name }}</span>
                                    </div>
                                </template>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Subgroups -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <template x-for="subgroup in currentSplit?.subgroups || []" :key="subgroup.id">
                            <div class="border-2 border-dashed rounded-lg p-4" 
                                 :style="`border-color: ${subgroup.color};`"
                                 @drop="assignParticipant($event.dataTransfer.getData('participantId'), subgroup.id)"
                                 @dragover.prevent>
                                <div class="flex items-center justify-between mb-3">
                                    <input type="text" x-model="subgroup.name" 
                                           class="font-semibold bg-transparent border-b border-gray-300 focus:border-gray-500 outline-none"
                                           :style="`color: ${subgroup.color};`">
                                    <button x-show="currentSplit.subgroups.length > 2" 
                                            @click="removeSubgroup(subgroup.id)" 
                                            class="text-red-500 hover:text-red-700">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                                
                                <!-- Assigned Participants -->
                                <div class="min-h-[60px] bg-gray-50 dark:bg-gray-900 rounded p-2">
                                    <template x-for="participantId in subgroup.participants" :key="participantId">
                                        <div class="inline-block mr-2 mb-2">
                                            <template x-for="collab in currentSplit.collaborators" :key="collab.userId">
                                                <template x-if="collab.userId === participantId">
                                                    <div class="participant-chip" :style="`background: ${collab.color};`">
                                                        <span class="text-white text-sm">{{ collab.name }}</span>
                                                    </div>
                                                </template>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                                
                                <!-- Destinations -->
                                <div class="mt-3">
                                    <label class="text-xs text-gray-500 dark:text-gray-400">Destinations:</label>
                                    <input type="text" placeholder="Add destinations..." 
                                           class="input-text w-full mt-1 text-sm">
                                </div>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Add Subgroup Button -->
                    <button @click="addSubgroup()" class="mt-4 w-full py-2 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-400 transition">
                        <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span class="text-sm">Add Another Group</span>
                    </button>
                </div>
                
                <!-- AI Suggestions -->
                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-semibold text-blue-700 dark:text-blue-300">🤖 AI Suggestions</h4>
                        <button class="text-xs text-blue-600 hover:text-blue-800">Generate</button>
                    </div>
                    <p class="text-sm text-blue-600 dark:text-blue-400">Based on participant preferences:</p>
                    <ul class="mt-2 space-y-1 text-sm">
                        <li>• Sarah & Mike enjoy art museums - suggest Orsay + Rodin</li>
                        <li>• Emma prefers shopping - suggest Le Marais district</li>
                    </ul>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
                <button @click="showSplitModal = false" class="btn-secondary">
                    Cancel
                </button>
                <button @click="saveSplitGroup()" class="btn-primary">
                    Create Split Group
                </button>
            </div>
        </div>
    </div>
    
    <style>
        .participant-chip {
            @apply px-3 py-1 rounded-full cursor-move inline-flex items-center;
        }
        .participant-chip:hover {
            @apply shadow-md;
        }
        [x-cloak] {
            display: none !important;
        }
    </style>

</body>
</html>